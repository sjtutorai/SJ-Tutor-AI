
import React, { useState, useEffect, useRef } from 'react';
import ReactMarkdown from 'react-markdown';
import { Loader2, Volume2, Square, ArrowLeft, Download, FileText, Image as ImageIcon, FileType, Share2, Facebook, Mail, MessageCircle, Link, RefreshCw } from 'lucide-react';
// @ts-ignore
import html2canvas from 'html2canvas';
// @ts-ignore
import { jsPDF } from 'jspdf';

interface ResultsViewProps {
  content: string;
  isLoading: boolean;
  title: string;
  type?: string; // 'Summary' | 'Essay' | 'Quiz' etc.
  onBack: () => void;
}

const ResultsView: React.FC<ResultsViewProps> = ({ content, isLoading, title, type = 'Document', onBack }) => {
  const [isPlaying, setIsPlaying] = useState(false);
  const [isDownloading, setIsDownloading] = useState(false);
  const contentRef = useRef<HTMLDivElement>(null);

  useEffect(() => {
    // Cleanup speech synthesis on unmount
    return () => {
      window.speechSynthesis.cancel();
    };
  }, []);

  useEffect(() => {
    if (isLoading) {
      window.speechSynthesis.cancel();
      setIsPlaying(false);
    }
  }, [isLoading, content]);

  const toggleSpeech = () => {
    if (isPlaying) {
      window.speechSynthesis.cancel();
      setIsPlaying(false);
    } else {
      if (!content) return;

      // Clean up text for better speech (remove some markdown symbols)
      const textToRead = content
        .replace(/[*#_`]/g, '') // Remove formatting characters
        .replace(/\[(.*?)\]\(.*?\)/g, '$1') // Keep link text, remove URL
        .replace(/\n/g, '. '); // Pause on newlines

      const utterance = new SpeechSynthesisUtterance(textToRead);
      utterance.rate = 1;
      utterance.pitch = 1;
      
      utterance.onend = () => setIsPlaying(false);
      utterance.onerror = () => setIsPlaying(false);
      
      window.speechSynthesis.speak(utterance);
      setIsPlaying(true);
    }
  };

  const getFilename = (ext: string) => {
    const cleanTitle = title.replace(/[^a-z0-9]/gi, '_').toLowerCase();
    const cleanType = type.toLowerCase();
    return `${cleanTitle}_${cleanType}.${ext}`;
  };

  const handleShare = async (platform?: string) => {
    const appUrl = window.location.href;
    const shareText = `${title} (${type})\n\n${content.substring(0, 300)}...\n\nRead more on SJ Tutor AI: ${appUrl}`;
    const fullContent = `${title} (${type})\n\n${content}\n\nGenerated by SJ Tutor AI\n${appUrl}`;

    if (!platform) {
        // Native Share or Copy
        if (navigator.share) {
            try {
              await navigator.share({
                title: `SJ Tutor AI: ${title}`,
                text: fullContent,
                url: appUrl,
              });
            } catch (err) {
              console.log("Share cancelled or failed", err);
            }
        } else {
            try {
              await navigator.clipboard.writeText(fullContent);
              alert('Content copied to clipboard!');
            } catch (err) {
              alert('Failed to copy content.');
            }
        }
        return;
    }

    let shareUrl = '';
    switch(platform) {
      case 'whatsapp':
        shareUrl = `https://wa.me/?text=${encodeURIComponent(shareText)}`;
        break;
      case 'facebook':
        shareUrl = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(appUrl)}&quote=${encodeURIComponent(shareText)}`;
        break;
      case 'gmail':
           shareUrl = `https://mail.google.com/mail/u/0/?view=cm&fs=1&su=${encodeURIComponent("SJ Tutor AI: " + title)}&body=${encodeURIComponent(fullContent)}`;
           break;
      case 'copy':
          try {
            await navigator.clipboard.writeText(fullContent);
            alert("Content copied to clipboard!");
          } catch(e) {
            alert("Failed to copy.");
          }
          return;
    }
    
    if (shareUrl) window.open(shareUrl, '_blank');
  };

  const downloadText = () => {
    const blob = new Blob([content], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = getFilename('txt');
    a.click();
    URL.revokeObjectURL(url);
  };

  const downloadWord = () => {
    if (!contentRef.current) return;
    
    // Add specific Word-compatible styling
    const htmlContent = `
      <html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'>
      <head>
        <meta charset='utf-8'>
        <title>${title}</title>
        <style>
          body { font-family: 'Calibri', 'Arial', sans-serif; font-size: 11pt; line-height: 1.5; color: #000000; }
          h1 { font-size: 18pt; font-weight: bold; color: #2E74B5; border-bottom: 1px solid #2E74B5; padding-bottom: 5px; margin-bottom: 15px; }
          h2 { font-size: 14pt; font-weight: bold; color: #1F4D78; margin-top: 15px; margin-bottom: 10px; }
          h3 { font-size: 12pt; font-weight: bold; color: #1F4D78; margin-top: 10px; margin-bottom: 5px; }
          p { margin-bottom: 10px; text-align: justify; }
          ul { margin-bottom: 10px; }
          li { margin-bottom: 5px; }
          strong { font-weight: bold; }
          em { font-style: italic; }
          .header-info { margin-bottom: 20px; font-style: italic; color: #666; font-size: 9pt; }
        </style>
      </head>
      <body>
        <h1>${title}</h1>
        <div class="header-info">
          <p>Type: ${type}</p>
          <p>Generated by SJ Tutor AI</p>
          <p>Date: ${new Date().toLocaleDateString()}</p>
        </div>
        ${contentRef.current.innerHTML}
      </body>
      </html>
    `;
    
    const blob = new Blob([htmlContent], { type: 'application/msword' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = getFilename('doc');
    a.click();
    URL.revokeObjectURL(url);
  };

  const downloadImage = async () => {
    if (!contentRef.current) return;
    setIsDownloading(true);
    try {
      const element = contentRef.current;
      const clone = element.cloneNode(true) as HTMLElement;
      
      // Style the clone for capture
      clone.style.position = 'absolute';
      clone.style.left = '-9999px';
      clone.style.top = '0';
      clone.style.width = '800px';
      clone.style.height = 'auto';
      clone.style.padding = '40px';
      clone.style.background = 'white';
      clone.style.color = '#1a202c'; // Ensure dark text
      
      const header = document.createElement('div');
      header.innerHTML = `
        <div style="margin-bottom: 30px; border-bottom: 2px solid #D4AF37; padding-bottom: 15px;">
          <h1 style="margin: 0; color: #1a202c; font-size: 28px; font-family: sans-serif;">${title}</h1>
          <p style="margin: 5px 0 0; color: #B7950B; font-weight: bold; text-transform: uppercase; font-size: 14px; font-family: sans-serif;">${type}</p>
        </div>
      `;
      clone.insertBefore(header, clone.firstChild);
      
      document.body.appendChild(clone);
      const canvas = await html2canvas(clone, { scale: 2, useCORS: true, backgroundColor: '#ffffff' });
      document.body.removeChild(clone);

      const image = canvas.toDataURL('image/png');
      const a = document.createElement('a');
      a.href = image;
      a.download = getFilename('png');
      a.click();
    } catch (e) {
      console.error("Image download failed", e);
      alert("Failed to generate image.");
    } finally {
      setIsDownloading(false);
    }
  };

  const downloadPDF = async () => {
    if (!contentRef.current) return;
    setIsDownloading(true);
    try {
      const element = contentRef.current;
      const clone = element.cloneNode(true) as HTMLElement;
      
      // A4 width in pixels at 96 DPI is approx 794px. We use 750 for content + margins.
      const a4WidthPx = 750;

      clone.style.position = 'absolute';
      clone.style.left = '-9999px';
      clone.style.top = '0';
      clone.style.width = `${a4WidthPx}px`; 
      clone.style.height = 'auto'; 
      clone.style.overflow = 'visible';
      clone.style.maxHeight = 'none';
      clone.style.background = 'white';
      clone.style.color = 'black'; // Force black text for PDF
      clone.style.padding = '40px';
      
      const header = document.createElement('div');
      header.innerHTML = `
        <div style="margin-bottom: 30px; border-bottom: 2px solid #D4AF37; padding-bottom: 15px; font-family: sans-serif;">
          <h1 style="margin: 0; color: #1a202c; font-size: 26px;">${title}</h1>
          <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 8px;">
            <span style="color: #B7950B; font-weight: bold; text-transform: uppercase; font-size: 12px;">${type}</span>
            <span style="color: #718096; font-size: 12px;">SJ Tutor AI - Generated on ${new Date().toLocaleDateString()}</span>
          </div>
        </div>
      `;
      clone.insertBefore(header, clone.firstChild);
      
      document.body.appendChild(clone);

      const canvas = await html2canvas(clone, { 
        scale: 2, // High resolution
        useCORS: true,
        logging: false,
        backgroundColor: '#ffffff',
        windowWidth: a4WidthPx + 100
      });
      
      document.body.removeChild(clone);

      const imgData = canvas.toDataURL('image/png');
      const pdf = new jsPDF('p', 'mm', 'a4');
      
      const pageWidth = pdf.internal.pageSize.getWidth();
      const pageHeight = pdf.internal.pageSize.getHeight();
      
      const widthRatio = pageWidth / canvas.width;
      const canvasHeight = canvas.height * widthRatio;
      
      let heightLeft = canvasHeight;
      let position = 0;

      // Add first page
      pdf.addImage(imgData, 'PNG', 0, position, pageWidth, canvasHeight);
      heightLeft -= pageHeight;

      // Add subsequent pages if content overflows
      while (heightLeft > 0) {
        position -= pageHeight;
        pdf.addPage();
        pdf.addImage(imgData, 'PNG', 0, position, pageWidth, canvasHeight);
        heightLeft -= pageHeight;
      }

      pdf.save(getFilename('pdf'));
    } catch (e) {
      console.error("PDF download failed", e);
      alert("Failed to generate PDF. Try downloading as Text or Word.");
    } finally {
      setIsDownloading(false);
    }
  };

  if (!content && !isLoading) return null;

  return (
    <div className="bg-white rounded-xl shadow-md border border-slate-200 overflow-hidden animate-in fade-in slide-in-from-bottom-4 duration-500">
      {/* Header Toolbar */}
      <div className="bg-slate-50 px-4 sm:px-6 py-4 border-b border-slate-200 flex flex-col sm:flex-row justify-between items-center gap-4">
        <div className="flex items-center gap-3 w-full sm:w-auto">
          <button 
            onClick={onBack}
            className="p-2 -ml-2 text-slate-400 hover:text-primary-600 hover:bg-slate-100 rounded-lg transition-colors"
            title="Back to Form"
          >
            <ArrowLeft className="w-5 h-5" />
          </button>
          <div className="flex flex-col overflow-hidden">
             <h3 className="font-semibold text-slate-800 truncate max-w-[200px] sm:max-w-xs">{title}</h3>
             <span className="text-xs text-slate-500 font-medium">{type}</span>
          </div>
        </div>
        
        <div className="flex flex-wrap justify-end gap-2 w-full sm:w-auto">
          {!isLoading && content && (
            <>
              {/* Export Options Group */}
              <div className="flex items-center bg-white border border-slate-200 rounded-lg p-1 shadow-sm">
                 <button 
                   onClick={() => handleShare()}
                   className="p-1.5 text-slate-500 hover:text-green-600 hover:bg-green-50 rounded-md transition-colors"
                   title="Share Content"
                 >
                   <Share2 className="w-4 h-4" />
                 </button>
                 <div className="w-px h-4 bg-slate-200 mx-1"></div>
                 <button 
                   onClick={downloadPDF} 
                   disabled={isDownloading}
                   className="p-1.5 text-slate-500 hover:text-red-600 hover:bg-red-50 rounded-md transition-colors disabled:opacity-50"
                   title="Download as PDF"
                 >
                   <FileType className="w-4 h-4" />
                 </button>
                 <div className="w-px h-4 bg-slate-200 mx-1"></div>
                 <button 
                   onClick={downloadWord} 
                   className="p-1.5 text-slate-500 hover:text-blue-600 hover:bg-blue-50 rounded-md transition-colors"
                   title="Download as Word"
                 >
                   <FileText className="w-4 h-4" />
                 </button>
                 <div className="w-px h-4 bg-slate-200 mx-1"></div>
                 <button 
                   onClick={downloadImage} 
                   disabled={isDownloading}
                   className="p-1.5 text-slate-500 hover:text-purple-600 hover:bg-purple-50 rounded-md transition-colors disabled:opacity-50"
                   title="Download as Image"
                 >
                   <ImageIcon className="w-4 h-4" />
                 </button>
                 <div className="w-px h-4 bg-slate-200 mx-1"></div>
                 <button 
                   onClick={downloadText} 
                   className="p-1.5 text-slate-500 hover:text-slate-800 hover:bg-slate-100 rounded-md transition-colors"
                   title="Download as Text"
                 >
                   <Download className="w-4 h-4" />
                 </button>
              </div>

              {/* Listen Button */}
              <button
                onClick={toggleSpeech}
                className={`flex items-center gap-2 px-3 py-1.5 rounded-lg text-sm font-medium transition-colors border shadow-sm ${
                  isPlaying 
                    ? 'bg-red-50 text-red-600 hover:bg-red-100 border-red-200' 
                    : 'bg-primary-50 text-primary-600 hover:bg-primary-100 border-primary-200'
                }`}
                title={isPlaying ? "Stop reading" : "Read aloud"}
              >
                {isPlaying ? (
                  <>
                    <Square className="w-3.5 h-3.5 fill-current" />
                    <span className="hidden sm:inline">Stop</span>
                  </>
                ) : (
                  <>
                    <Volume2 className="w-4 h-4" />
                    <span className="hidden sm:inline">Listen</span>
                  </>
                )}
              </button>
            </>
          )}
        </div>

        {isLoading && (
          <div className="flex items-center text-primary-600 text-sm font-medium animate-pulse">
            <Loader2 className="w-4 h-4 mr-2 animate-spin" />
            Generating {type}...
          </div>
        )}
      </div>
      
      {/* Content Area */}
      <div className="p-6 sm:p-8 min-h-[300px]" ref={contentRef}>
        <div className="markdown-body text-slate-700 bg-white">
          <ReactMarkdown>{content}</ReactMarkdown>
        </div>
        {content === '' && isLoading && (
          <div className="flex flex-col items-center justify-center py-20 text-slate-400">
            <Loader2 className="w-10 h-10 mb-4 animate-spin text-primary-300" />
            <p className="text-sm font-medium">Initializing {type.toLowerCase()} generator...</p>
          </div>
        )}
      </div>
      
      {/* Footer Share Section */}
      {!isLoading && (
        <div className="p-6 bg-slate-50 border-t border-slate-100">
            <div className="flex flex-col items-center gap-4">
                <p className="text-xs font-bold text-slate-400 uppercase tracking-widest">Share this {type}</p>
                <div className="flex flex-wrap justify-center gap-3">
                    <button 
                      onClick={() => handleShare('whatsapp')} 
                      className="flex items-center gap-2 px-4 py-2 bg-[#25D366] text-white rounded-full hover:brightness-110 transition-transform shadow-sm active:scale-95" 
                      title="Share on WhatsApp"
                    >
                        <MessageCircle className="w-4 h-4 fill-current" />
                        <span className="text-xs font-bold">WhatsApp</span>
                    </button>
                    <button 
                      onClick={() => handleShare('facebook')} 
                      className="flex items-center gap-2 px-4 py-2 bg-[#1877F2] text-white rounded-full hover:brightness-110 transition-transform shadow-sm active:scale-95" 
                      title="Share on Facebook"
                    >
                        <Facebook className="w-4 h-4 fill-current" />
                        <span className="text-xs font-bold">Facebook</span>
                    </button>
                    <button 
                      onClick={() => handleShare('gmail')} 
                      className="flex items-center gap-2 px-4 py-2 bg-[#EA4335] text-white rounded-full hover:brightness-110 transition-transform shadow-sm active:scale-95" 
                      title="Share via Gmail"
                    >
                        <Mail className="w-4 h-4 fill-current" />
                        <span className="text-xs font-bold">Gmail</span>
                    </button>
                    <button 
                      onClick={() => handleShare('copy')} 
                      className="flex items-center gap-2 px-4 py-2 bg-slate-800 text-white rounded-full hover:bg-slate-900 transition-transform shadow-sm active:scale-95" 
                      title="Copy to Clipboard"
                    >
                        <Link className="w-4 h-4" />
                        <span className="text-xs font-bold">Copy Link</span>
                    </button>
                </div>
                
                <button 
                    onClick={onBack}
                    className="mt-6 text-sm font-semibold text-primary-700 hover:text-primary-800 hover:underline flex items-center gap-2 group"
                >
                    <RefreshCw className="w-3.5 h-3.5 group-hover:rotate-180 transition-transform duration-500" />
                    Generate Another Version
                </button>
            </div>
        </div>
      )}
    </div>
  );
};

export default ResultsView;
